# Flow Diagrams: Mobile vs Desktop Study Plan Discrepancy

## Current Authentication & Storage Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         DESKTOP BROWSER                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                      â”‚
â”‚  User Login: test@example.com                                       â”‚
â”‚       â”‚                                                              â”‚
â”‚       â”œâ”€â–º Generate UUID: aaaa-aaaa-aaaa-aaaa                        â”‚
â”‚       â”‚                                                              â”‚
â”‚       â”œâ”€â–º Store in localStorage:                                    â”‚
â”‚       â”‚   {                                                          â”‚
â”‚       â”‚     id: "aaaa-aaaa-aaaa-aaaa",                              â”‚
â”‚       â”‚     email: "test@example.com",                              â”‚
â”‚       â”‚     name: "test"                                             â”‚
â”‚       â”‚   }                                                          â”‚
â”‚       â”‚                                                              â”‚
â”‚       â””â”€â–º Create Study Plan                                         â”‚
â”‚            â”‚                                                         â”‚
â”‚            â”œâ”€â–º Try Supabase:                                        â”‚
â”‚            â”‚   INSERT INTO study_plans                              â”‚
â”‚            â”‚   (user_id='aaaa-aaaa', subject='Math', ...)           â”‚
â”‚            â”‚   âœ“ Success                                            â”‚
â”‚            â”‚                                                         â”‚
â”‚            â””â”€â–º Generate Lesson:                                     â”‚
â”‚                INSERT INTO lessons                                  â”‚
â”‚                (user_id='aaaa-aaaa', topic='Algebra', ...)          â”‚
â”‚                âœ“ Cached                                             â”‚
â”‚                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         MOBILE BROWSER                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                      â”‚
â”‚  User Login: test@example.com (SAME EMAIL!)                         â”‚
â”‚       â”‚                                                              â”‚
â”‚       â”œâ”€â–º Generate UUID: bbbb-bbbb-bbbb-bbbb  âš ï¸ DIFFERENT!         â”‚
â”‚       â”‚                                                              â”‚
â”‚       â”œâ”€â–º Store in localStorage:                                    â”‚
â”‚       â”‚   {                                                          â”‚
â”‚       â”‚     id: "bbbb-bbbb-bbbb-bbbb",  âš ï¸ NEW UUID                 â”‚
â”‚       â”‚     email: "test@example.com",                              â”‚
â”‚       â”‚     name: "test"                                             â”‚
â”‚       â”‚   }                                                          â”‚
â”‚       â”‚                                                              â”‚
â”‚       â””â”€â–º Fetch Study Plans                                         â”‚
â”‚            â”‚                                                         â”‚
â”‚            â”œâ”€â–º Query Supabase:                                      â”‚
â”‚            â”‚   SELECT * FROM study_plans                            â”‚
â”‚            â”‚   WHERE user_id='bbbb-bbbb'  âš ï¸ DOESN'T MATCH          â”‚
â”‚            â”‚   âœ— Returns: []  (empty array)                         â”‚
â”‚            â”‚                                                         â”‚
â”‚            â”œâ”€â–º Fallback to localStorage:                            â”‚
â”‚            â”‚   âœ— Empty (different browser)                          â”‚
â”‚            â”‚                                                         â”‚
â”‚            â””â”€â–º Result: NO STUDY PLANS FOUND âŒ                       â”‚
â”‚                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        DATA LOCATION                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                      â”‚
â”‚  Supabase Database:                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚  â”‚ study_plans table:                           â”‚                   â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚                   â”‚
â”‚  â”‚ â”‚ id â”‚ user_id       â”‚ subject  â”‚ topics â”‚  â”‚                   â”‚
â”‚  â”‚ â”œâ”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚                   â”‚
â”‚  â”‚ â”‚ 1  â”‚ aaaa-aaaa-... â”‚ Math     â”‚ [...]  â”‚  â”‚ â† Desktop data   â”‚
â”‚  â”‚ â”‚ 2  â”‚ aaaa-aaaa-... â”‚ Physics  â”‚ [...]  â”‚  â”‚ â† Desktop data   â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚                   â”‚
â”‚  â”‚                                              â”‚                   â”‚
â”‚  â”‚ lessons table:                               â”‚                   â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚                   â”‚
â”‚  â”‚ â”‚ subject â”‚ topic   â”‚ user_id     â”‚ ... â”‚  â”‚                   â”‚
â”‚  â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¤  â”‚                   â”‚
â”‚  â”‚ â”‚ Math    â”‚ Algebra â”‚ aaaa-aaaa...â”‚ ... â”‚  â”‚ â† Desktop cache  â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”˜  â”‚                   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â”‚                                                                      â”‚
â”‚  Desktop localStorage:                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚  â”‚ csec_mock_user: {                           â”‚                   â”‚
â”‚  â”‚   id: "aaaa-aaaa-aaaa-aaaa",                â”‚                   â”‚
â”‚  â”‚   email: "test@example.com"                 â”‚                   â”‚
â”‚  â”‚ }                                            â”‚                   â”‚
â”‚  â”‚ csec_mock_plans: []  (using Supabase)       â”‚                   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â”‚                                                                      â”‚
â”‚  Mobile localStorage: (SEPARATE STORAGE)                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚  â”‚ csec_mock_user: {                           â”‚                   â”‚
â”‚  â”‚   id: "bbbb-bbbb-bbbb-bbbb",  âš ï¸ DIFFERENT  â”‚                   â”‚
â”‚  â”‚   email: "test@example.com"                 â”‚                   â”‚
â”‚  â”‚ }                                            â”‚                   â”‚
â”‚  â”‚ csec_mock_plans: []                         â”‚                   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â”‚                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## The Problem in Action

```
Timeline: User's Experience Across Devices

Day 1 - Desktop:
  09:00 AM â†’ Sign up with test@example.com
            â†’ UUID: aaaa-aaaa generated
  09:15 AM â†’ Create "Mathematics" study plan
            â†’ Saved to Supabase with user_id=aaaa-aaaa
  09:30 AM â†’ Complete Algebra lesson
            â†’ Lesson cached with user_id=aaaa-aaaa
  10:00 AM â†’ See progress: 1/10 topics done âœ“

Day 1 - Mobile (Same Day):
  12:00 PM â†’ Sign in with test@example.com
            â†’ UUID: bbbb-bbbb generated âš ï¸
  12:01 PM â†’ Check study plans
            â†’ Query: SELECT * WHERE user_id='bbbb-bbbb'
            â†’ Result: Empty []
            â†’ User sees: "No study plans yet" âŒ
  12:02 PM â†’ User confused: "Where did my plan go?"

Day 2 - Desktop:
  09:00 AM â†’ User returns to desktop
            â†’ Sign in again with test@example.com
            â†’ UUID: cccc-cccc generated âš ï¸ (NEW AGAIN!)
  09:01 AM â†’ Check study plans
            â†’ Query: SELECT * WHERE user_id='cccc-cccc'
            â†’ Result: Empty []
            â†’ User sees: "No study plans yet" âŒ
  09:02 AM â†’ User frustrated: "I created a plan yesterday!"
```

## localStorage Isolation

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Browser Storage Model                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                           â”‚
â”‚  Desktop Chrome                        Mobile Safari     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  localStorage        â”‚              â”‚ localStorage â”‚  â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€     â”‚              â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚  â”‚
â”‚  â”‚  csec_mock_user:     â”‚              â”‚ csec_mock... â”‚  â”‚
â”‚  â”‚  {                   â”‚              â”‚ {            â”‚  â”‚
â”‚  â”‚    id: "aaaa-aaaa"   â”‚   âœ— NO SYNC  â”‚   id: "bbbb" â”‚  â”‚
â”‚  â”‚    email: "test@.."  â”‚  â•â•â•â•â•â•â•â•â•â•â•â–ºâ”‚   email: ... â”‚  â”‚
â”‚  â”‚  }                   â”‚              â”‚ }            â”‚  â”‚
â”‚  â”‚                      â”‚              â”‚              â”‚  â”‚
â”‚  â”‚  csec_mock_plans:    â”‚              â”‚ csec_mock_.. â”‚  â”‚
â”‚  â”‚  [...]               â”‚              â”‚ [...]        â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                           â”‚
â”‚  Key Fact: localStorage is scoped to:                    â”‚
â”‚  - Origin (protocol + domain + port)                     â”‚
â”‚  - Browser/Device                                        â”‚
â”‚  - User Profile (in some browsers)                       â”‚
â”‚                                                           â”‚
â”‚  There is NO cross-device synchronization built-in.      â”‚
â”‚                                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Lesson Cache Isolation

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Lesson Caching with Personalization               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  Desktop User (user_id: aaaa-aaaa):                            â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                             â”‚
â”‚                                                                 â”‚
â”‚  Request: GET lesson for Math/Algebra                          â”‚
â”‚     â”‚                                                           â”‚
â”‚     â”œâ”€â–º Cache Lookup:                                          â”‚
â”‚     â”‚   SELECT * FROM lessons                                  â”‚
â”‚     â”‚   WHERE subject='Math'                                   â”‚
â”‚     â”‚     AND topic='Algebra'                                  â”‚
â”‚     â”‚     AND user_id='aaaa-aaaa'  â† Personalized cache       â”‚
â”‚     â”‚                                                           â”‚
â”‚     â”œâ”€â–º Result: Found âœ“                                        â”‚
â”‚     â””â”€â–º Return cached lesson (no AI call)                      â”‚
â”‚                                                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  Mobile User (user_id: bbbb-bbbb, SAME EMAIL):                 â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                   â”‚
â”‚                                                                 â”‚
â”‚  Request: GET lesson for Math/Algebra                          â”‚
â”‚     â”‚                                                           â”‚
â”‚     â”œâ”€â–º Cache Lookup:                                          â”‚
â”‚     â”‚   SELECT * FROM lessons                                  â”‚
â”‚     â”‚   WHERE subject='Math'                                   â”‚
â”‚     â”‚     AND topic='Algebra'                                  â”‚
â”‚     â”‚     AND user_id='bbbb-bbbb'  â† Different user_id!       â”‚
â”‚     â”‚                                                           â”‚
â”‚     â”œâ”€â–º Result: Not Found âœ—                                    â”‚
â”‚     â”‚                                                           â”‚
â”‚     â””â”€â–º Generate New Lesson:                                   â”‚
â”‚         - Call OpenRouter API  ğŸ’° (costs credits)              â”‚
â”‚         - Generate 2000+ word lesson                           â”‚
â”‚         - Cache with user_id='bbbb-bbbb'                       â”‚
â”‚         - Return new lesson                                    â”‚
â”‚                                                                 â”‚
â”‚  Impact: Duplicate lesson generation wastes AI credits         â”‚
â”‚          Even though it's the SAME topic for SAME user!        â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Proposed Solution: Deterministic UUID

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚             Proposed Fix: Deterministic UUID from Email          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  Current Behavior:                                              â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                               â”‚
â”‚  email â†’ crypto.randomUUID() â†’ UUID (random, changes each time) â”‚
â”‚                                                                  â”‚
â”‚  test@example.com â†’ aaaa-aaaa-aaaa-aaaa  (desktop, day 1)       â”‚
â”‚  test@example.com â†’ bbbb-bbbb-bbbb-bbbb  (mobile, day 1)        â”‚
â”‚  test@example.com â†’ cccc-cccc-cccc-cccc  (desktop, day 2)       â”‚
â”‚                                                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  Proposed Behavior:                                             â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                              â”‚
â”‚  email â†’ hash(email) â†’ UUID (deterministic, always same)        â”‚
â”‚                                                                  â”‚
â”‚  test@example.com â†’ sha256(test@example.com) â†’ format as UUID   â”‚
â”‚                   â†’ a1b2c3d4-e5f6-7890-abcd-ef1234567890        â”‚
â”‚                                                                  â”‚
â”‚  test@example.com â†’ a1b2c3d4-e5f6-7890-abcd-ef1234567890        â”‚
â”‚  (desktop, day 1)                                               â”‚
â”‚                                                                  â”‚
â”‚  test@example.com â†’ a1b2c3d4-e5f6-7890-abcd-ef1234567890        â”‚
â”‚  (mobile, day 1)    â†‘ SAME UUID!                                â”‚
â”‚                                                                  â”‚
â”‚  test@example.com â†’ a1b2c3d4-e5f6-7890-abcd-ef1234567890        â”‚
â”‚  (desktop, day 2)   â†‘ SAME UUID!                                â”‚
â”‚                                                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  Result:                                                        â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€                                                        â”‚
â”‚  âœ“ Same user_id across all devices                             â”‚
â”‚  âœ“ Study plans accessible everywhere                           â”‚
â”‚  âœ“ Lesson cache shared across devices                          â”‚
â”‚  âœ“ Progress persists across sessions                           â”‚
â”‚  âœ“ Minimal code changes required                               â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Data Flow Comparison

### Before (Current):

```
User Action          â†’  UUID Generated  â†’  Storage Key        â†’  Accessible From
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Signup (Desktop)     â†’  aaaa-aaaa       â†’  user_id=aaaa-aaaa  â†’  Desktop only âœ—
Login (Mobile)       â†’  bbbb-bbbb       â†’  user_id=bbbb-bbbb  â†’  Mobile only âœ—
Re-login (Desktop)   â†’  cccc-cccc       â†’  user_id=cccc-cccc  â†’  Nowhere! âœ—
```

### After (With Deterministic UUID):

```
User Action          â†’  UUID Generated  â†’  Storage Key        â†’  Accessible From
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Signup (Desktop)     â†’  hash(email)     â†’  user_id=xxxx-xxxx  â†’  Everywhere âœ“
Login (Mobile)       â†’  hash(email)     â†’  user_id=xxxx-xxxx  â†’  Everywhere âœ“
Re-login (Desktop)   â†’  hash(email)     â†’  user_id=xxxx-xxxx  â†’  Everywhere âœ“
```

## Code Location Map

```
csec-tutor/
â”œâ”€â”€ lib/
â”‚   â”œâ”€â”€ auth.tsx                    âš ï¸ UUID generation happens here
â”‚   â”‚   â”œâ”€â”€ Line 164-171: signUp() 
â”‚   â”‚   â””â”€â”€ Line 211-226: signIn()
â”‚   â”‚
â”‚   â”œâ”€â”€ plan-storage.ts             âš ï¸ Plan fetching by user_id
â”‚   â”‚   â”œâ”€â”€ Line 97-112: fetchPlans()
â”‚   â”‚   â””â”€â”€ Line 122-145: fetchPlan()
â”‚   â”‚
â”‚   â””â”€â”€ lesson-cache.ts             â„¹ï¸ Cache versioning logic
â”‚       â””â”€â”€ Line 81-104: shouldUseCachedLesson()
â”‚
â”œâ”€â”€ app/api/ai/coaching/route.ts    âš ï¸ Lesson cache by user_id
â”‚   â”œâ”€â”€ Line 44-74: getScopedCachedLesson()
â”‚   â””â”€â”€ Line 153-157: Cache scope determination
â”‚
â””â”€â”€ app/dashboard/page.tsx          â„¹ï¸ Where users see the issue
    â””â”€â”€ Line 50-76: fetchStudyPlans()
```

---

**Legend:**
- âš ï¸ = Root cause location
- â„¹ï¸ = Related but not root cause
- âœ“ = Working as expected
- âœ— = Issue occurs here
- ğŸ’° = Costs money/credits
